<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Carregando...</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0a0a0a',
                        darker: '#050505',
                        accent: '#ee4d2d',
                        'accent-light': '#ff6b4a',
                        gold: '#ffd700',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- UTMify Pixel -->
    <script>
        window.pixelId = "6978fe17e8ad9e20f040ab3e";
        var a = document.createElement("script");
        a.setAttribute("async", "");
        a.setAttribute("defer", "");
        a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
        document.head.appendChild(a);
    </script>

    <!-- UTMify UTMs -->
    <script
        src="https://cdn.utmify.com.br/scripts/utms/latest.js"
        data-utmify-prevent-xcod-sck
        data-utmify-prevent-subids
        async
        defer
    ></script>

    <!-- Meta Pixel Code -->
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '1890930384857911');
        fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=1890930384857911&ev=PageView&noscript=1"
    /></noscript>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            background: #050505;
            color: #fff;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 3px;
        }

        /* Image carousel */
        .carousel-container {
            position: relative;
            overflow: hidden;
        }

        .carousel-track {
            display: flex;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .carousel-slide {
            min-width: 100%;
        }

        /* Dots */
        .dot {
            transition: all 0.3s ease;
        }

        .dot.active {
            width: 24px;
            background: #ee4d2d;
        }

        /* Buy button pulse */
        .btn-buy {
            animation: btnPulse 2s infinite;
        }

        @keyframes btnPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(238, 77, 45, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(238, 77, 45, 0); }
        }

        /* Star rating */
        .star {
            color: #ffd700;
        }

        /* Loading */
        .loading-spinner {
            border: 3px solid #1a1a1a;
            border-top-color: #ee4d2d;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen pb-24">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-50 bg-darker/90 backdrop-blur-xl border-b border-white/5">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-accent to-accent-light flex items-center justify-center">
                    <span class="text-white font-bold text-lg">S</span>
                </div>
                <span class="text-white font-semibold text-lg hidden sm:block">Shopee Ofertas</span>
            </a>
            
            <div class="flex items-center gap-3">
                <div class="px-3 py-1.5 rounded-full bg-green-500/10 border border-green-500/20">
                    <span class="text-green-400 text-xs font-medium">üîí Compra Segura</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="product-container" class="pt-20">
        <!-- Loading State -->
        <div id="loading-state" class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-white/50">Carregando produto...</p>
            </div>
        </div>
    </main>

    <!-- Fixed Buy Button -->
    <div id="fixed-buy-btn" class="fixed bottom-0 left-0 right-0 p-4 bg-darker/95 backdrop-blur-xl border-t border-white/10 hidden z-50">
        <a id="buy-btn-link" href="#" class="btn-buy block w-full py-4 rounded-2xl bg-gradient-to-r from-accent to-accent-light text-white text-center font-bold text-lg transition-all hover:opacity-90 active:scale-[0.98]">
            Comprar Agora
        </a>
    </div>

    <script>
        const API_URL = '/api/products';

        function getSlugFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('slug');
        }

        async function fetchProduct(slug) {
            try {
                const response = await fetch(`${API_URL}?slug=${slug}`);
                if (!response.ok) return null;
                const product = await response.json();
                
                const params = new URLSearchParams(window.location.search);
                const preview = params.get('preview') === '1';
                
                if (!preview && product.status !== 'active') {
                    return null;
                }
                
                return product;
            } catch (error) {
                console.error('Error fetching product:', error);
                return null;
            }
        }

        function generateStars(rating) {
            return Array(5).fill(0).map((_, i) => 
                `<span class="star">${i < rating ? '‚òÖ' : '‚òÜ'}</span>`
            ).join('');
        }

        function renderProduct(product) {
            document.getElementById('page-title').textContent = product.title;
            document.title = product.title;

            const discount = product.discount || Math.round(((product.priceOriginal - product.pricePromo) / product.priceOriginal) * 100);
            const installments = product.installments || 3;
            const installmentValue = (product.pricePromo / installments).toFixed(2);

            const images = product.images?.length ? product.images : ['https://via.placeholder.com/600x600/1a1a1a/333?text=Produto'];

            const container = document.getElementById('product-container');
            container.innerHTML = `
                <!-- Image Carousel -->
                <div class="carousel-container bg-gradient-to-b from-white/[0.02] to-transparent">
                    <div class="carousel-track" id="carousel-track">
                        ${images.map(img => `
                            <div class="carousel-slide">
                                <img src="${img}" alt="${product.title}" class="w-full aspect-square object-cover">
                            </div>
                        `).join('')}
                    </div>
                    
                    ${images.length > 1 ? `
                        <!-- Navigation Arrows -->
                        <button onclick="prevSlide()" class="absolute left-4 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/50 backdrop-blur-sm text-white flex items-center justify-center hover:bg-black/70 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        </button>
                        <button onclick="nextSlide()" class="absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/50 backdrop-blur-sm text-white flex items-center justify-center hover:bg-black/70 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                        
                        <!-- Dots -->
                        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2" id="carousel-dots">
                            ${images.map((_, i) => `
                                <button class="dot w-2 h-2 rounded-full bg-white/30 ${i === 0 ? 'active' : ''}" onclick="goToSlide(${i})"></button>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <!-- Discount Badge -->
                    ${discount ? `
                        <div class="absolute top-4 left-4 px-4 py-2 rounded-xl bg-accent text-white font-bold">
                            -${discount}% OFF
                        </div>
                    ` : ''}
                </div>

                <!-- Product Info -->
                <div class="px-4 py-6">
                    <!-- Price Section -->
                    <div class="mb-6">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="text-4xl font-black text-white">R$ ${product.pricePromo || '0,00'}</span>
                            ${product.priceOriginal ? `
                                <span class="text-lg text-white/40 line-through">R$ ${product.priceOriginal}</span>
                            ` : ''}
                        </div>
                        <p class="text-white/60">
                            Em at√© <span class="text-accent font-semibold">${installments}x de R$ ${installmentValue}</span> sem juros
                        </p>
                    </div>

                    <!-- Title -->
                    <h1 class="text-xl font-bold text-white mb-4 leading-tight">${product.title}</h1>

                    <!-- Stats -->
                    <div class="flex items-center gap-4 mb-6">
                        <div class="flex items-center gap-1 text-yellow-400 text-sm">
                            ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ <span class="text-white/60 ml-1">5.0</span>
                        </div>
                        <span class="text-white/30">|</span>
                        <span class="text-white/60 text-sm">${product.sold || 0} vendidos</span>
                    </div>

                    <!-- Timer -->
                    <div class="p-4 rounded-2xl bg-accent/10 border border-accent/20 mb-6">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-accent text-lg">‚ö°</span>
                                <span class="text-white font-medium">Oferta Rel√¢mpago</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <div class="px-2 py-1 rounded bg-accent text-white text-sm font-bold" id="timer-h">00</div>
                                <span class="text-accent">:</span>
                                <div class="px-2 py-1 rounded bg-accent text-white text-sm font-bold" id="timer-m">00</div>
                                <span class="text-accent">:</span>
                                <div class="px-2 py-1 rounded bg-accent text-white text-sm font-bold" id="timer-s">00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Features -->
                    <div class="grid grid-cols-3 gap-3 mb-8">
                        <div class="p-3 rounded-xl bg-white/5 border border-white/10 text-center">
                            <span class="text-xl mb-1 block">üöö</span>
                            <span class="text-xs text-white/60">Frete Gr√°tis</span>
                        </div>
                        <div class="p-3 rounded-xl bg-white/5 border border-white/10 text-center">
                            <span class="text-xl mb-1 block">üîí</span>
                            <span class="text-xs text-white/60">Compra Segura</span>
                        </div>
                        <div class="p-3 rounded-xl bg-white/5 border border-white/10 text-center">
                            <span class="text-xl mb-1 block">‚Ü©Ô∏è</span>
                            <span class="text-xs text-white/60">Devolu√ß√£o Gr√°tis</span>
                        </div>
                    </div>

                    <!-- Seller -->
                    <div class="p-4 rounded-2xl bg-white/5 border border-white/10 mb-8">
                        <div class="flex items-center gap-4">
                            <img src="${product.sellerLogo || 'https://via.placeholder.com/60x60/1a1a1a/333?text=S'}" 
                                 alt="${product.sellerName || 'Vendedor'}"
                                 class="w-14 h-14 rounded-full object-cover border-2 border-accent/30">
                            <div class="flex-1">
                                <h3 class="text-white font-semibold">${product.sellerName || 'Shopee Brasil'}</h3>
                                <p class="text-white/50 text-sm">${product.sellerLocation || 'Brasil'}</p>
                            </div>
                            <div class="text-right">
                                <div class="text-green-400 text-sm font-medium">‚úì Verificado</div>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    ${product.description || product.descTitle ? `
                        <div class="mb-8">
                            <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                <span class="w-1 h-6 bg-accent rounded-full"></span>
                                Descri√ß√£o
                            </h2>
                            <div class="p-5 rounded-2xl bg-white/5 border border-white/10">
                                ${product.descTitle ? `<h3 class="text-white font-semibold mb-3">${product.descTitle}</h3>` : ''}
                                ${product.description ? `<p class="text-white/70 leading-relaxed mb-4">${product.description}</p>` : ''}
                                
                                ${product.specs ? `
                                    <div class="pt-4 border-t border-white/10">
                                        <h4 class="text-white/80 font-medium mb-2">Especifica√ß√µes:</h4>
                                        <ul class="space-y-1 text-white/60 text-sm">
                                            ${product.specs.split('\n').map(spec => `<li>‚Ä¢ ${spec}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}

                                ${product.includes ? `
                                    <div class="pt-4 mt-4 border-t border-white/10">
                                        <h4 class="text-white/80 font-medium mb-2">O que est√° incluso:</h4>
                                        <p class="text-white/60 text-sm">${product.includes.split('\n').join(' | ')}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}

                    <!-- Guarantee -->
                    <div class="p-5 rounded-2xl bg-gradient-to-br from-green-500/10 to-green-500/5 border border-green-500/20 mb-8">
                        <h3 class="text-green-400 font-bold mb-3 flex items-center gap-2">
                            <span>üõ°Ô∏è</span> Nossa Garantia
                        </h3>
                        <ul class="space-y-2 text-white/70 text-sm">
                            <li class="flex items-start gap-2">
                                <span class="text-green-400">‚úì</span>
                                <span><strong>Envio seguro:</strong> Rastreamento em tempo real + seguro</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-green-400">‚úì</span>
                                <span><strong>Devolu√ß√£o:</strong> 30 dias para troca ou reembolso</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-green-400">‚úì</span>
                                <span><strong>Garantia:</strong> 90 dias com suporte premium</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Reviews -->
                    ${product.reviews?.length ? `
                        <div class="mb-8">
                            <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                <span class="w-1 h-6 bg-gold rounded-full"></span>
                                Avalia√ß√µes (${product.reviews.length})
                            </h2>
                            <div class="space-y-4">
                                ${product.reviews.map(review => `
                                    <div class="p-4 rounded-2xl bg-white/5 border border-white/10">
                                        <div class="flex items-center gap-3 mb-3">
                                            <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white font-semibold">
                                                ${(review.name || 'A')[0].toUpperCase()}
                                            </div>
                                            <div class="flex-1">
                                                <h4 class="text-white font-medium">${review.name || 'An√¥nimo'}</h4>
                                                <div class="flex items-center gap-2">
                                                    <span class="text-yellow-400 text-sm">${generateStars(review.rating || 5)}</span>
                                                    <span class="text-white/40 text-xs">${review.date || ''}</span>
                                                </div>
                                            </div>
                                        </div>
                                        ${review.text ? `<p class="text-white/70 text-sm">${review.text}</p>` : ''}
                                        ${review.image ? `<img src="${review.image}" alt="Foto" class="mt-3 rounded-xl max-h-40 object-cover">` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            // Show buy button
            const fixedBtn = document.getElementById('fixed-buy-btn');
            const buyLink = document.getElementById('buy-btn-link');
            buyLink.href = product.checkoutUrl || '#';
            fixedBtn.classList.remove('hidden');

            // Initialize carousel
            initCarousel(images.length);
            
            // Start timer
            startTimer();
        }

        function showError(message) {
            const container = document.getElementById('product-container');
            container.innerHTML = `
                <div class="min-h-screen flex items-center justify-center px-4">
                    <div class="text-center">
                        <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-white/5 flex items-center justify-center">
                            <span class="text-4xl">üòï</span>
                        </div>
                        <h2 class="text-xl font-bold text-white mb-2">Produto n√£o encontrado</h2>
                        <p class="text-white/50 mb-6">${message}</p>
                        <a href="index.html" class="inline-flex items-center gap-2 px-6 py-3 rounded-xl bg-accent text-white font-medium hover:bg-accent-light transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                            Voltar √†s ofertas
                        </a>
                    </div>
                </div>
            `;
        }

        // Carousel
        let currentSlide = 0;
        let totalSlides = 0;

        function initCarousel(total) {
            totalSlides = total;
        }

        window.nextSlide = function() {
            currentSlide = (currentSlide + 1) % totalSlides;
            updateCarousel();
        };

        window.prevSlide = function() {
            currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
            updateCarousel();
        };

        window.goToSlide = function(index) {
            currentSlide = index;
            updateCarousel();
        };

        function updateCarousel() {
            const track = document.getElementById('carousel-track');
            if (track) {
                track.style.transform = `translateX(-${currentSlide * 100}%)`;
            }

            const dots = document.querySelectorAll('.dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === currentSlide);
            });
        }

        // Timer
        function startTimer() {
            let totalSeconds = 10 * 60; // 10 minutes

            function update() {
                const h = Math.floor(totalSeconds / 3600);
                const m = Math.floor((totalSeconds % 3600) / 60);
                const s = totalSeconds % 60;

                const hEl = document.getElementById('timer-h');
                const mEl = document.getElementById('timer-m');
                const sEl = document.getElementById('timer-s');

                if (hEl) hEl.textContent = h.toString().padStart(2, '0');
                if (mEl) mEl.textContent = m.toString().padStart(2, '0');
                if (sEl) sEl.textContent = s.toString().padStart(2, '0');

                if (totalSeconds > 0) {
                    totalSeconds--;
                    setTimeout(update, 1000);
                } else {
                    totalSeconds = 10 * 60;
                    update();
                }
            }

            update();
        }

        // Touch swipe for carousel
        let touchStartX = 0;
        document.addEventListener('touchstart', e => touchStartX = e.touches[0].clientX);
        document.addEventListener('touchend', e => {
            const diff = touchStartX - e.changedTouches[0].clientX;
            if (Math.abs(diff) > 50) {
                diff > 0 ? nextSlide() : prevSlide();
            }
        });

        // Initialize
        async function init() {
            const slug = getSlugFromUrl();
            
            if (!slug) {
                showError('Nenhum produto especificado');
                return;
            }

            const product = await fetchProduct(slug);
            
            if (!product) {
                showError('Este produto n√£o existe ou foi removido');
                return;
            }

            renderProduct(product);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
